# 2.4 DNS: 인터넷의 디렉터리 서비스
### 호스트 이름(hostname)
호스트 이름은 호스트 식별자 중 하나로 `www.facebook.com` 같이 기억하기 쉽다.<br/>

그러나, 그 호스트 위치에 대한 정보를 거의 제공하지 않고,<br/>
호스트 이름은 **가변 길이의 알파뉴메릭 문자**로 구성되므로 라우터가 처리하기 어렵다.<br/>
<br/>

### IP 주소(IP address)
호스트 이름의 한계로 인해 호스트는 흔히 `IP 주소`로도 식별된다.<br/>

IP 주소는 4바이트로 구성되고 **계층 구조**를 갖는다.<br/>
주소를 왼쪽에서 오른쪽으로 조사하며 호스트가 어디 위치하는지에 대한 자세한 정보를 얻는다.<br/>
<br/>

## 2.4.1 DNS가 제공하는 서비스
사람은 좀 더 기억하기 쉬운 **호스트 이름 식별자**를 좋아하지만,<br/>
라우터는 고정 길이의 계층 구조를 가진 **IP 주소**를 좋아한다.<br/>

이러한 선호 차이를 절충하기 위해, 호스트 이름을 IP 주소로 변환해주는 디렉터리 서비스가 필요<br/>

### DNS(domain name system)
1️. DNS 서버들의 계층구조로 구현된 분산 데이터 베이스<br/>
2️. 호스트가 분산 데이터 베이스로 질의하도록 허락하는 애플리케이션 계층 프로토콜<br/>

- DNS 서버는 주로 **BIND(Berkeley Internet Name Domain) 소프트웨어**를 실행하는 유닉스 컴퓨터<br/>
- DNS 프로토콜은 **UDP**상에서 수행되고 `포트 번호 53`을 이용한다.<br/>
- DNS는 다른 애플리케이션 프로토콜들이 HTTP, SMTP, FTP 등 사용자가 제공한<br/>
  호스트 이름을 IP 주소로 변환하기 위헤 주로 이용한다.
<br/>

### 사용자의 호스트에서 수행하는 브라우저가 URL을 요청했을 때 발생하는 일
```
1. 같은 사용자 컴퓨터는 DNS 애플리케이션의 클라이언트를 수행한다.
2. 브라우저는 URL로부터 호스트 이름을 추출하고 그 호스트 이름을 DNS 애플리케이션의 클라이언트측에 넘긴다.
3. DNS 클라이언트는 DNS 서버로 호스트 이름을 포함하는 질의를 보낸다.
4. DNS 클라이언트는 결국 호스트 이름에 대한 IP 주소를 가진 응답을 받게 된다.
5. 브라우저가 DNS로부터 IP 주소를 받으면, 브라우저는 해당 IP 주소와
   그 주소의 80번 포트에 위치하는 HTTP 서버 프로세스로 TCP 연결을 초기화한다.
```
<br/>

> 위 예로부터 DNS는 DNS를 사용하는 인터넷 애플리케이션에 추가 지연을 준다는 것을 알 수 있다.<br/>
> 다행히도, IP 주소는 가까운 DNS 서버에 `캐싱`되어 있어 평균 DNS 지연뿐 아니라 DNS 네트워크 트래픽 감소에도 도움을 준다.<br/>
<br/>

### 호스트 이름을 IP 주소로 변환하는 것 이외의 서비스
`호스트 에일리어싱(host aliasing)`<br/>

복잡한 호스트 이름을 가진 호스트는 하나 이상의 별명을 가질 수 있다.<br/>
예를 들어, relay1.west-coast.enterprise.com 같은 **호스트 이름**은 enterprise.com, www.enterprise.com 같은 별칭을 가질 수 있다.<br/>

이 경우에 relay1.west-coast.enterprise.com를 `정식 호스트 이름(canonical hostname)`이라고 한다.<br/>
> DNS는 호스트의 IP주소 뿐만 아니라 제시한 별칭 호스트 이름에 대한 정식 호스트 이름을 얻기 위해 이용될 수 있다.<br/>
<br/>

`메일 서버 에일리어싱(mail server aliasing)`<br/>

전자 메일 주소는 기억하기 쉬운 것이 좋다.<br/>
<br/>

`부하 분산(load distribution)`<br/>

DNS는 중복 웹 서버 같은 여러 중복 서버 사이에 부하를 분산하기 위해서도 사용되고 있다.<br/>
여러 서버에 중복되어 있는 사이트는, 각 서버가 다른 종단 시스템에서 수행되고 다른 IP 주소를 갖는다.<br/>
> `중복 웹 서버`같은 경우, 여러 IP 주소가 하나의 정식 호스트 이름과 연관되어 있다.<br/>
> `DNS 데이터베이스`는 이 IP 주소 집합을 갖고 있다.<br/>
<br/>

```
1. 클라이언트가 주소 집합으로 매핑하는 호스트 이름에 대한 DNS 질의
2. 서버는 IP 주소 집합 전체를 가지고 응답
```
이 때 각 응답에서의 주소는 `순환식`으로 보낸다.<br/>
클라이언트는 대체로 주소 집합 내부의 첫 번째 IP 주소로 HTTP 요청 메시지를 보내므로, DNS의 순환 방식은 트래픽을 분산하는 효과를 낸다.<br/>
<br/>

## 2.4.2 DNS 동작 원리 개요
여기서는 호스트 이름을 IP 주소로 변환하는 서비스에 초점을 맞춘다.<br/>
사용자의 호스트에서 실행되는 어떤 애플리케이션이 호스트 이름을 IP 주소로 변환하려 한다고 가정하자.<br/>
- 과정
```
1. 애플리케이션은 변환될 호스트 이름을 명시하여 DNS 측의 클라이언트를 호출
2. 사용자 호스트의 DNS는 네트워크에 질의 메시지를 보낸다.
  > 모든 질의와 응답 메시지는 포트 53의 UDP 데이터그램으로 보내진다.
3. 수 밀리초에서 수 초의 지연 후에 사용자 호스트의 DNS는 요청한 매핑에 해당하는 DNS 응답 메시지를 받는다.
4. 이 매핑은 호출한 애플리케이션으로 전달된다.
```

DNS는 간단해보이지만 매우 복잡한데, 이는 전 세계에 분산된 많은 DNS 서버 뿐만 아니라<br/>
DNS 서버와 질의를 하는 호스트 사이에서 어떻게 통신하는지를 명시하는 애플리케이션 계층 프로토콜로 구성되어 있다.<br/>
<br/>

### 중앙 집중 방식
클라이언트는 모든 질의를 단일 네임 서버로 보내고, DNS 서버는 질의 클라이언트에게 직접 응답한다.<br/>
이 방식은 간단하므로 매력적이지만, 아래와 같은 문제점을 생각해볼 수 있다.<br/>

- `서버의 고장`
  - 만약 이 네임 서버가 고장나면, 전체 인터넷이 작동하지 않는다.
- `트래픽양`
  - 단일 DNS 서버가 모든 DNS 질의를 처리해야 한다.
- `먼 거리의 중앙 집중 데이터베이스`
  - 단일 DNS 서버가 모든 질의 클라이언트로부터 **가까울 수만은 없다.**
  - 경우에 따라 혼잡한 링크를 거쳐 지구 반대편까지 여행해야할 수도 있다. 이는 심각한 지연을 일으킨다.
- `유지관리`
  - 단일 네임 서버는 모든 인터넷 호스트에 대한 레코드를 유지해야 한다.
  - 이 중앙 집중 데이터베이스를 자주 갱신하고, 사용자 인증과 관련된 문제가 있다.
<br/>

요약하면, 단일 DNS 서버에 있는 중앙 집중 데이터베이스는 `확장성`이 전혀 없다.<br/>
결과적으로 DNS는 `분산`되도록 설계되었다.<br/>
<br/>

**DNS 서버 계층구조의 일부**
<p align="center"><img width="600" src="https://github.com/user-attachments/assets/81c29d78-810a-4b83-95cc-0a03df5494cf")

<br/>
<br/>

## 분산 계층 데이터베이스
확장성 문제를 다루기 위해 DNS는 많은 서버를 이용하고 이들을 계층 형태로 구성하며 전 세계에 분산시킨다.<br/>

### 계층 DNS 서버의 종류
`루트(root) DNS 서버`<br/>

- 1000개 이상의 루트 서버 인스턴스가 전 세계에 흩어져 있다.
- 루트 서버들은 13개의 다른 루트 서버 복사체이고, 12개의 다른 기관에서 관리된다. 
- 인터넷 할당 번호 관리기관 ICANN(Internet Corporation for Assigned Names and Numbers)에 의해 조정된다.
- 루트 네임 서버는 TLD 서버의 IP 주소들을 제공한다.
<br/>

`최상위 레벨 도메인(top-level domain, TLD) DNS 서버`<br/>

- com, org, net 같은 상위 레벨 도메인과 kr, uk 같은 모든 국가의 상위 레벨 도메인에 대한 TLD 서버가 있다.
- TLD 서버는 책임 DNS 서버에 대한 IP 주소를 제공한다.
<br/>

`책임(authoritative) DNS 서버`<br/>

- 인터넷에서 접근하기 쉬운 호스트를 가진 모든 기관은 호스트 이름을 IP 주소로 매핑하는 공개적인 DNS 레코드를 제공해야 한다.
- 기관의 책임 DNS 서버는 이 DNS 레코드를 갖고 있다.
- 기관은 자신의 책임 DNS 서버의 구현을 선택할 수 있고, 일부 서비스 제공자의 책임 DNS 서버에 이 레코드를 저장하도록 비용을 지불한다.
<br/>

`로컬(local) DNS 서버`<br/>

- 로컬 DNS 서버는 서버들의 계층 구조에 엄격하게 속하지는 않지만 DNS 구조의 중심에 있다.
- ISP는 로컬 DNS 서버를 갖고, 로컬 DNS 서버로부터 IP 주소를 호스트에게 제공한다.
- 대체로 호스트에 **가까이** 있기 때문에 지연이 적다.
<br/>

### 예시
호스트 `cse.nyu.edu`가 `gaia.cs.umass.edu`의 IP 주소를 원한다고 가정하자.<br/>
또한, cse.nyu.edu에 대한 NYU의 로컬 DNS 서버가 dns.nyu.edu이고,<br/>
gaia.cs.umass.edu에 대한 책임 DNS 서버는 dns.umass.edu라고 가정하자.<br/>
<br/>

**다양한 DNS 서버의 상호작용**
<p align="center"><img width="400" src="https://github.com/user-attachments/assets/6821246d-e1a7-470d-83b5-2634133cd2ec")

<br/>
<br/>

- 과정
```
1. 호스트 cse.nyu.edu가 자신의 로컬 DNS 서버 dns.nyu.edu에 DNS 질의를 보낸다.
  > 이 때 질의에는 변환되어야 하는 호스트 이름이 포함된다.
2. 로컬 DNS 서버는 그 질의 메시지를 루트 DNS 서버에게 전달한다.
3. 루트 DNS 서버는 edu를 인식하고, edu에 대한 책임을 가진 TLD 서버의 IP 주소 목록을 로컬 DNS 서버에 보낸다.
4. 로컬 DNS 서버는 질의 메시지를 TLD 서버로 보낸다.
5. TLD 서버는 umass.edu를 인식하고, dns.umass.edu로 이름 지어진 책임 DNS 서버의 IP 주소로 응답한다.
6. 로컬 DNS 서버는 직접 책임 DNS 서버로 질의 메시지를 다시 보낸다.
7. 최종 gaia.cs.umass.edu의 IP 주소로 응답한다.
8. 호스트에 최종 IP 주소로 응답한다.
```

이 예에서 하나의 호스트 이름 매핑을 얻기 위해 **질의 메시지 네 번**과 **응답 메시지 네 번**, `총 8번`의 DNS 메시지가 보내졌다.<br/>

일반적으로 TLD 서버는 위의 예시와 같이 책임 DNS 서버를 알지 않고, 책임 DNS 서버를 아는 중간 DNS 서버를 알고 있다.<br/>
- 로컬 DNS서버는 로컬 DNS서버에게 원하는 매핑 결과를 돌려주는 책임 DNS 서버에게 질의 한 번
- 로컬 DNS서버는 요청한 호스트에게 그 매핑 결과를 전달 한 번<br/>

이 경우에 `전체 10번`의 메시지를 보내게 된다.<br/>
<br/>

아래 그림에서는 `재귀적 질의(recursive query)`와 `반복적 질의(iterative query)`를 사용한다.<br/>
cse.nyu.edu로부터 dns.nyu.edu로 보내는 질의는 자신을 대신하여 필요한 매핑을 얻도록 dns.nyu.edu에게 요구하므로 **재귀적 질의**다.<br/>
그러나 다른 세 가지 질의는 모든 응답이 dns.nyu.edu에 직접 보내지므로 **반복적 질의**다.<br/>
> 💡이론상 DNS 질의는 반복적이고 재귀적일 수 있다.
<br/>

**DNS에서의 재귀적 질의**
<p align="center"><img width="400" src="https://github.com/user-attachments/assets/aaf06ae7-7046-4b3e-b6ad-2935a76b11bd")

<br/>
<br/>

### DNS 캐싱(caching)
실제로 DNS는 지연 성능 향상과 네트워크의 DNS 메시지 수를 줄이기 위해 `캐싱(caching)`을 사용한다.<br/>
> 질의 사슬에서 DNS 서버는 DNS 응답을 받았을 때 로컬 메모리에 응답에 대한 정보를 저장할 수 있다.<br/>
<br/>

만약 호스트의 이름과 IP 주소 쌍이 DNS 서버에 저장되고 다른 호스트 이름으로부터 같은 질의가 DNS 서버로 도착한다면,<br/>
DNS 서버는 호스트 이름에 대한 책임이 없을 때조차 원하는 IP 주소를 제공할 수 있다.<br/>
호스트 DNS와 IP 사이의 매핑과 호스트는 영구적이지 않기 때문에 어떤 기간(흔히 2일로 설정) 이후에 저장된 정보를 제거한다.<br/>

로컬 DNS 서버는 또한 TLD 서버의 IP주소를 저장할 수 있다.<br/>
그러므로 로컬 DNS 서버가 질의 사슬에서 루트 DNS 서버를 우회하게 한다(이것은 자주 일어난다).<br/>
<br/>

## 2.4.3 DNS 레코드와 메시지
