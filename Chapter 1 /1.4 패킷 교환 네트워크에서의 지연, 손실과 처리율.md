# 1.4 패킷 교환 네트워크에서의 지연, 손실과 처리율
컴퓨터 네트워크는 반드시 두 종단 시스템 간에 처리율(전달될 수 있는 초당 데이터의 양)을<br/>
제한하여 종단 시스템간의 지연을 야기하며 실제로 패킷을 잃어버리기도 한다.<br/>
이러한 문제들을 어떻게 다룰 것인가?<br/>

<br/>

## 1.4.1 패킷 교환 네트워크에서의 지연 개요
패킷은 한 호스트에서 시작하고 다른 호스트로 전달 되는 동안 다양한 지연을 겪게 된다.<br/>
- `노드 처리 지연(nodal processing delay)`
- `큐잉 지연(queuing delay)`
- `전송 지연(transmission delay)`
- `전파 지연(propagation delay)`
- 위와 같은 지연들이 쌓여서 `전체 노드 지연(total nodal delay)`을 일으킨다.<br/>

<br/>

### 지연 유형
아래 그림은 지연되는 과정<br/>
1. 패킷이 업스트림 노드로부터 라우터 A에 도착<br/>
2. 라우터 A는 그 패킷에 대한 출력 링크를 결정하기 위해 패킷 헤더 조사<br/>
3. 선택된 링크를 통해 패킷을 라우터 B로 전송<br/>
3-1. 링크에 현재 전송되는 다른 패킷이 없고, 큐의 맨 앞에 있다면 바로 링크로 전송<br/>
3-2. **링크가 이용중이거나, 큐에 대기하는 패킷이 있다면** 큐의 맨 뒤로 들어간다.<br/>

<p align="center"><img width="600" src="https://github.com/jmKim02/ComputerNetworking_A-Top-Down-Approach/assets/174222202/f66e163e-fa59-4037-9857-9cb9e4bc95b2">

<br/>
<br/>

### 처리 지연(processing delay)
📌 `패킷 헤더`를 조사하고 그 패킷을 어디로 보낼지를 결정하는 시간<br/>
<br/>

- `처리 지연`은 업스트림 노드에서 라우터 A로 패킷의 비트를 전송하면서 발생하는 **패킷의 비트 오류**를<br/>
  조사하는 데 필요한 시간과 같은 요소를 포함할 수도 있다.
- 고속 라우터에서 처리 지연은 일반적으로 수 마이크로초

 <br/>

### 큐잉 지연(queuing delay)
📌 패킷이 큐에서 링크로 전송되기를 기다리는 시간<br/>
<br/>

- 패킷의 `큐잉 지연 길이`는 큐에서 대기중인 다른 패킷의 수에 의해 결정된다.
  - 당연히 패킷의 지연은 패킷마다 상당이 다르다.
  - 큐가 비어 있고 다른 패킷이 전송 중인 상태가 아니라면 큐잉 지연은 0
  - 트래픽이 많고 다른 많은 패킷이 전송 대기중이면 큐잉 지연은 매우 길어질 것
- 현실에서 큐잉 지연은 수 마이크로초 ~ 수 밀리초

<br/>

### 전송 지연(transmission delay)
📌 패킷의 모든 비트를 링크로 전송하는 데 필요한 시간<br/>
<br/>

- 패킷의 길이를 L비트, 라우터 A에서 라우터 B까지 링크 전송률은 R bps로 나타낸다.
  - R은 링크의 전송률에 의해 결정
  - e.g.) 10 Mbps 이더넷 링크의 경우 전송률 R은 10 Mbps
- `전송 지연`은 `L/R`이다.
- 일반적으로 수 마이크로초 ~ 수 밀리초

<br/>

### 전파 지연(propagation delay)
📌 링크의 처음부터 라우터 B까지의 전파에 필요한 시간<br/>
<br/>

- 일단 비트가 링크에 전해지면 라우터 B까지 전해져야 한다.
- 비트는 링크의 전파 속도로 전파된다.
- `전파 속도`는 링크의 **물리 매체(광섬유, 꼬임쌍선 등)**에 따라 다른데 범위는 다음과 같다
  - 2 * 10<sup>8</sup> 미터/초 ~ 3 * 10<sup>8</sup> 미터/초
  - 이는 빛의 속도와 같거나 약간 작은 정도
- `전파 지연`은 두 라우터 사이의 거리를 전파 속도로 나눈 것
  - 즉, **d / s**(d는 두 라우터 사이의 거리, s는 링크의 전파 속도)
- 광역 네트워크에서 일반적으로 수 밀리초

<br/>

### 전송 지연과 전파 지연 비교
`전송 지연`은 라우터가 패킷을 내보내는 데 필요한 시간<br/>
> 💡패킷 길이와 링크 전송률의 함수, **두 라우터 사이의 거리와는 관계없다.**
<br/>

`전파 지연`은 비트가 한 라우터에서 다음 라우터로 전파되는 데 걸리는 시간
> 💡두 라우터 사이의 거리에 대한 함수, **패킷 길이와 링크 전송률과는 관계없다.**
<br/>

- 이해를 돕기 위해 100 km마다 요금계산소가 있는 고속도로에 대한 경우로 생각해보자.
  - `링크`: 고속도로 요금계산소 사이
  - `라우터`: 고속도로 요금계산소
  - `전파 속도`: 시속 100 km
  - `전송률` : 12초마다 1대의 차를 서비스(전송) -> 5대/분
  - `패킷`: 10대의 차를 하나의 패킷(각 자동차들은 비트)
    - 각 10대의 차량 대열의 첫 번째 자동차는 요금계산소에 다른 9대의 차가 도착할 때까지 **저장**된다.
<br/>

<p align="center"><img width="600" src="https://github.com/jmKim02/ComputerNetworking_A-Top-Down-Approach/assets/174222202/17ee7aae-1698-46f8-8b5b-967be91f30f4">

<br/>

- 요금계산소가 전체 자동차를 밀어내는 데 걸리는 시간: (10대) / (5대/분) = 2분(전송 지연)
- 한 자동차가 한 요금계산소에서 다음 요금계산소로 이동하는 데 걸리는 시간: (100km) / (100km/h) = 1시간(전파지연)

<br/>

## 1.4.2 큐잉 지연과 패킷 손실
큐잉 지연은 다른 세 가지 지연과는 다르게 패킷마다 다를 수 있다.<br/>
그렇다면 언제 큐잉 지연이 크고, 언제 미미한가?<br/>
<br/>

**큐잉 지연을 결정하는 주 요소들<br/>**
- 트래픽이 큐에 도착하는 비율
- 링크의 전송률
- 도착하는 트래픽의 특성 (트래픽이 주기에 맞춰서 또는 버스트(burst)하게 도착하는가?)

<br/>

**트래픽을 이해하기 위한 가정들**
- 패킷이 큐에 도착하는 평균율: **a(패킷/초)**
- 전송률: **R**(비트/초)
- 패킷: **L비트**
- 비트가 큐에 도착하는 평균율: **La비트/초**
- `트래픽 강도(traffic intensity)`: **La/R**, 트래픽 강도는 큐잉 지연 정도 측정에 매우 중요!
  - La/R > 1이면, 비트가 큐에 도착하는 평균율이 비트가 큐에 전송되는 비율을 초과
    - 큐는 끝 없이 증가하고 큐잉 지연은 무한대에 도달
    > 💡 따라서 트래픽 공학의 중요 규칙 중 하나는 **트래픽 강도가 1보다 크지 않게 설계하라는 것**<br/>
  - La/R <= 1이면, 도착 트래픽의 특성이 큐잉 지연에 영향을 미친다.
    - 패킷이 **L/R초마다 주기적으로** 도착한다면, 모든 패킷은 빈 큐에 도착하고 큐잉 지연은 없다.
    - 반면에 패킷이 주기적이 아니라 몰려서(버스트) 도착한다면, **상당한 평균 큐잉 지연** 발생

<br/>

<p align="center"><img width="600" src="https://github.com/jmKim02/ComputerNetworking_A-Top-Down-Approach/assets/174222202/5f689c74-54f9-4742-8160-dfb214184feb">

<br/>

- 트래픽 강도가 0에 가까울 경우
  - 패킷 도착이 드물고 간격이 멀어서 다음에 도착하는 패킷이 큐에서 다른 패킷 발견하는 경우가 적을 없을 것
  - **평균 큐잉 지연은** 0에 가까워진다.
- 트래픽 강도가 1에 가까울 경우
  - 패킷 도착이 전송용량을 초과하여 큐가 생성될 것
  - 트래픽 강도가 1에 접근할수록 **평균 큐의 길이는** 점점 증가한다.

<br/>

### 패킷 손실
현실에서 큐 용량은 유한하므로 트래픽강도가 1에 접근함에 따라 패킷 지연이 실제 무한대가 되진 않는다.<br/>
대신 패킷이 도착해 큐가 꽉 찬 것을 발견하게 된다, 이런 경우 라우터는 **패킷을 버린다.**<br/>
<br/>

- 종단 시스템 입장에서 `패킷 손실`은 **네트워크 코어**로 전송되었으나 목적지에 나타나지 않는 것으로 보인다.
- **손실 패킷의 비율은 트래픽 강도가 클수록 증가**
- 손실 패킷은 모든 데이터가 궁극적으로 출발지에서 목적지까지 전달되었음을 보장하기 위해 종단 간에 재전송될 수 있다.

<br/>

## 1.4.3 종단 간 지연
이제 한 라우터에서의 지연이 아니라 출발지에서 목적지까지의 지연을 간략히 생각해보자.<br/>
- 출발지 호스트와 목적지 호스트 사이에 N - 1개의 라우터 존재
- 네트워크가 혼잡하지 않다.(큐잉 지연은 무시 가능)
- 각 라우터와 출발지 호스트의 처리 지연은 d<sub>proc</sub>
- 각 호스트와 출발지 호스트에서의 전송률은 R비트/초
- 각 링크에서의 전파 지연은 d<sub>prop</sub>
- 종단 간 지연
<br/>

<p align="center"><img width="600" src="https://github.com/jmKim02/ComputerNetworking_A-Top-Down-Approach/assets/174222202/4d497086-d7c9-45c1-a197-84101b33b193">

<br/>
<br/>

### 종단 시스템, 애플리케이션 그리고 그 밖의 지연
처리, 전송, 전파 지연 이외에도 종단 시스템에서 중요한 지연이 더 있을 수 있다.<br/>
아래 문제들은 기회가 되면 이후 자세히 살펴볼 것이다.<br/>

- `공유매체`로 패킷을 전송하고자 하는 종단 시스템은 전송을 **의도적으로** 지연시킬 수 있다.
- `VoIP(Voice-over-IP)` 애플리케이션에 있는 **미디어 패킷화 지연(media packetization delay)**
